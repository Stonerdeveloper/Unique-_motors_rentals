{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/tech_alchemist/Documents/CarRental/src/app/api/proxy-booking/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nexport async function POST(request: Request) {\n    try {\n        const body = await request.json();\n        const { car_id, driver_id, customer_name, phone, email, pickup_location, pickup_date, return_date } = body;\n\n        const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n        const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n        if (!supabaseUrl || !supabaseAnonKey) {\n            console.error(\"Server Error: Missing Supabase Keys\");\n            return NextResponse.json(\n                { error: \"Server configuration error\" },\n                { status: 500 }\n            );\n        }\n\n        const supabase = createClient(supabaseUrl, supabaseAnonKey);\n\n        // 1. Fetch Car details\n        const { data: car, error: carErr } = await supabase\n            .from(\"cars\")\n            .select(\"price_per_day\")\n            .eq(\"id\", car_id)\n            .single();\n\n        if (carErr || !car) {\n            console.error(\"Car Fetch Error:\", carErr);\n            return NextResponse.json({ error: \"Car not found or unavailable\" }, { status: 400 });\n        }\n\n        // 2. Calculate Price\n        const startDate = new Date(pickup_date);\n        const endDate = new Date(return_date);\n        const dayDiff = (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24);\n        const days = Math.max(1, Math.ceil(dayDiff));\n        const total_price = Number(car.price_per_day) * days;\n\n        // 3. Insert Booking\n        const { data: booking, error: bookingErr } = await supabase.from(\"bookings\").insert({\n            car_id,\n            driver_id: driver_id || null,\n            customer_name,\n            phone,\n            email,\n            pickup_location,\n            pickup_date,\n            return_date,\n            total_price,\n            payment_status: \"pending\",\n            booking_status: \"pending\",\n        }).select().single();\n\n        if (bookingErr) {\n            console.error(\"Booking Insert Error:\", bookingErr);\n            return NextResponse.json({ error: \"Failed to create booking record\" }, { status: 500 });\n        }\n\n        // 4. Generate Payment URL (Mock)\n        const checkoutUrl = `https://pay.uniquemotors.ng/checkout?amount=${total_price}&ref=${booking.id}`;\n\n        return NextResponse.json({\n            booking_id: booking.id,\n            checkout_url: checkoutUrl,\n            message: \"Booking created successfully\"\n        }, { status: 200 });\n\n    } catch (error) {\n        console.error(\"Booking API Error:\", error);\n        return NextResponse.json(\n            { error: \"Internal Server Error during booking\" },\n            { status: 500 }\n        );\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAgB;IACvC,IAAI;QACA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,MAAM,EAAE,SAAS,EAAE,aAAa,EAAE,KAAK,EAAE,KAAK,EAAE,eAAe,EAAE,WAAW,EAAE,WAAW,EAAE,GAAG;QAEtG,MAAM;QACN,MAAM;QAEN;;QAQA,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa;QAE3C,uBAAuB;QACvB,MAAM,EAAE,MAAM,GAAG,EAAE,OAAO,MAAM,EAAE,GAAG,MAAM,SACtC,IAAI,CAAC,QACL,MAAM,CAAC,iBACP,EAAE,CAAC,MAAM,QACT,MAAM;QAEX,IAAI,UAAU,CAAC,KAAK;YAChB,QAAQ,KAAK,CAAC,oBAAoB;YAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA+B,GAAG;gBAAE,QAAQ;YAAI;QACtF;QAEA,qBAAqB;QACrB,MAAM,YAAY,IAAI,KAAK;QAC3B,MAAM,UAAU,IAAI,KAAK;QACzB,MAAM,UAAU,CAAC,QAAQ,OAAO,KAAK,UAAU,OAAO,EAAE,IAAI,CAAC,OAAO,KAAK,KAAK,EAAE;QAChF,MAAM,OAAO,KAAK,GAAG,CAAC,GAAG,KAAK,IAAI,CAAC;QACnC,MAAM,cAAc,OAAO,IAAI,aAAa,IAAI;QAEhD,oBAAoB;QACpB,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC;YAChF;YACA,WAAW,aAAa;YACxB;YACA;YACA;YACA;YACA;YACA;YACA;YACA,gBAAgB;YAChB,gBAAgB;QACpB,GAAG,MAAM,GAAG,MAAM;QAElB,IAAI,YAAY;YACZ,QAAQ,KAAK,CAAC,yBAAyB;YACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkC,GAAG;gBAAE,QAAQ;YAAI;QACzF;QAEA,iCAAiC;QACjC,MAAM,cAAc,CAAC,4CAA4C,EAAE,YAAY,KAAK,EAAE,QAAQ,EAAE,EAAE;QAElG,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,YAAY,QAAQ,EAAE;YACtB,cAAc;YACd,SAAS;QACb,GAAG;YAAE,QAAQ;QAAI;IAErB,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,sBAAsB;QACpC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAuC,GAChD;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}